<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="generator" content="Observable Framework v1.13.0">
<title>Petal-X: Cardiovascular Disease (CVD) Risk Calculator</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="preload" as="style" href="./_observablehq/theme-air,alt.7f878b97.css">
<link rel="preload" as="style" href="./_observablehq/stdlib/inputs.ea9fd553.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="stylesheet" type="text/css" href="./_observablehq/theme-air,alt.7f878b97.css">
<link rel="stylesheet" type="text/css" href="./_observablehq/stdlib/inputs.ea9fd553.css">
<link rel="modulepreload" href="./_observablehq/client.5f9bd24c.js">
<link rel="modulepreload" href="./_observablehq/runtime.f168f711.js">
<link rel="modulepreload" href="./_observablehq/stdlib.d907f99e.js">
<link rel="modulepreload" href="./_import/components/petalx.a3b7c61d.js">
<link rel="modulepreload" href="./_import/components/score2.f53b186e.js">
<link rel="modulepreload" href="./_npm/htl@0.3.1/063eb405.js">
<link rel="modulepreload" href="./_observablehq/stdlib/inputs.743bb3ef.js">
<link rel="modulepreload" href="./_npm/@observablehq/plot@0.6.16/e828d8c8.js">
<link rel="modulepreload" href="./_import/components/geoPetal.64d7f1a5.js">
<link rel="modulepreload" href="./_npm/d3@7.9.0/7055d4c5.js">
<link rel="modulepreload" href="./_npm/d3-geo@3.1.1/src/cartesian.6dc17dd0.js">
<link rel="modulepreload" href="./_npm/d3-geo@3.1.1/src/constant.af971ad1.js">
<link rel="modulepreload" href="./_npm/d3-geo@3.1.1/src/math.bcbfe5c9.js">
<link rel="modulepreload" href="./_npm/d3-geo@3.1.1/src/rotation.49d26523.js">
<link rel="modulepreload" href="./_npm/isoformat@0.2.1/c68fbd73.js">
<link rel="modulepreload" href="./_npm/interval-tree-1d@1.0.4/a62ae5ce.js">
<link rel="modulepreload" href="./_npm/d3-array@3.2.4/e95f898e.js">
<link rel="modulepreload" href="./_npm/d3-axis@3.0.0/d44feff9.js">
<link rel="modulepreload" href="./_npm/d3-brush@3.0.0/5830b12a.js">
<link rel="modulepreload" href="./_npm/d3-chord@3.0.1/84d7b8e9.js">
<link rel="modulepreload" href="./_npm/d3-color@3.1.0/2c0cdfa2.js">
<link rel="modulepreload" href="./_npm/d3-contour@4.0.2/626bedc4.js">
<link rel="modulepreload" href="./_npm/d3-delaunay@6.0.4/00c41b5d.js">
<link rel="modulepreload" href="./_npm/d3-dispatch@3.0.1/b5f7cdc6.js">
<link rel="modulepreload" href="./_npm/d3-drag@3.0.0/b22c5864.js">
<link rel="modulepreload" href="./_npm/d3-dsv@3.0.1/407f7a1f.js">
<link rel="modulepreload" href="./_npm/d3-ease@3.0.1/6f15f633.js">
<link rel="modulepreload" href="./_npm/d3-fetch@3.0.1/ef1ec490.js">
<link rel="modulepreload" href="./_npm/d3-force@3.0.0/5e1ff060.js">
<link rel="modulepreload" href="./_npm/d3-format@3.1.0/5851d7ef.js">
<link rel="modulepreload" href="./_npm/d3-geo@3.1.1/dcd02767.js">
<link rel="modulepreload" href="./_npm/d3-hierarchy@3.1.2/f1db2593.js">
<link rel="modulepreload" href="./_npm/d3-interpolate@3.0.1/034b7bcb.js">
<link rel="modulepreload" href="./_npm/d3-path@3.1.0/4bb53638.js">
<link rel="modulepreload" href="./_npm/d3-polygon@3.0.1/bbafde58.js">
<link rel="modulepreload" href="./_npm/d3-quadtree@3.0.1/aa5b35a8.js">
<link rel="modulepreload" href="./_npm/d3-random@3.0.1/32c7fec2.js">
<link rel="modulepreload" href="./_npm/d3-scale@4.0.2/567840a0.js">
<link rel="modulepreload" href="./_npm/d3-scale-chromatic@3.1.0/cf9b720b.js">
<link rel="modulepreload" href="./_npm/d3-selection@3.0.0/5dcd62f4.js">
<link rel="modulepreload" href="./_npm/d3-shape@3.2.0/f8e03c56.js">
<link rel="modulepreload" href="./_npm/d3-time@3.1.0/5bc129e1.js">
<link rel="modulepreload" href="./_npm/d3-time-format@4.1.0/19c92b44.js">
<link rel="modulepreload" href="./_npm/d3-timer@3.0.1/f31b5398.js">
<link rel="modulepreload" href="./_npm/d3-transition@3.0.1/8debb4ba.js">
<link rel="modulepreload" href="./_npm/d3-zoom@3.0.0/4b0cc581.js">
<link rel="modulepreload" href="./_npm/d3-geo@3.1.1/src/compose.128617db.js">
<link rel="modulepreload" href="./_npm/binary-search-bounds@2.0.5/1ee6c50d.js">
<link rel="modulepreload" href="./_npm/internmap@2.0.3/5eed35fd.js">
<link rel="modulepreload" href="./_npm/delaunator@5.0.1/e67acb27.js">
<link rel="modulepreload" href="./_npm/robust-predicates@3.0.2/8ac9039b.js">
<link rel="icon" href="./_file/petalx.934e6466.png" type="image/png" sizes="96x96">
<script type="module">

import {define} from "./_observablehq/client.5f9bd24c.js";
import {registerFile} from "./_observablehq/stdlib.d907f99e.js";

registerFile("./data/labels_en.json", {"name":"./data/labels_en.json","mimeType":"application/json","path":"./_file/data/labels_en.303506a7.json","lastModified":1730907435620,"size":1691});
registerFile("./data/score2_surrogate.json", {"name":"./data/score2_surrogate.json","mimeType":"application/json","path":"./_file/data/score2_surrogate.bcb0c236.json","lastModified":1730802041727,"size":1238});

define({id: "ea9db2f2", outputs: ["petalx","score2"], body: async () => {
const [{petalx}, {default: score2}] = await Promise.all([import("./_import/components/petalx.a3b7c61d.js"), import("./_import/components/score2.f53b186e.js")]);

return {petalx,score2};
}});

define({id: "34b79cae", inputs: ["FileAttachment"], outputs: ["fullData","labels"], body: (FileAttachment) => {
const fullData = FileAttachment("./data/score2_surrogate.json").json();
const labels = FileAttachment("./data/labels_en.json").json();
return {fullData,labels};
}});

define({id: "2a2bbd08", inputs: ["Inputs","labels","Generators"], outputs: ["sexInput","ageInput","sbpInput","smokingInput","tholInput","hdlInput","sex","age","sbp","smoking","thol","hdl","patientInput","patient"], body: (Inputs,labels,Generators) => {
// Inputs
const sexInput = Inputs.radio(labels.sexLevels, {
  value: 0,
  keyof: (d) => d,
  valueof: (_, i) => i,
});
const ageInput = Inputs.range([45, 69], { step: 1, value: 51 });
const sbpInput = Inputs.range([100, 180], { step: 1, value: 120 });
const smokingInput = Inputs.radio(labels.binaryLevels, {
  value: 0,
  keyof: (d) => d,
  valueof: (_, i) => i,
});
const tholInput = Inputs.range([3, 9], { step: 0.1, value: 4.5 });
const hdlInput = Inputs.range([0.5, 2.5], { step: 0.1, value: 0.5 });

const sex = Generators.input(sexInput);
const age = Generators.input(ageInput);
const sbp = Generators.input(sbpInput);
const smoking = Generators.input(smokingInput);
const thol = Generators.input(tholInput);
const hdl = Generators.input(hdlInput);

const patientInput = Inputs.text({
  placeholder: labels.patientPlaceholder,
});
const patient = Generators.input(patientInput);
return {sexInput,ageInput,sbpInput,smokingInput,tholInput,hdlInput,sex,age,sbp,smoking,thol,hdl,patientInput,patient};
}});

define({id: "1257a42e", inputs: ["score2","sex","age","smoking","sbp","thol","hdl"], outputs: ["score2Risk"], body: (score2,sex,age,smoking,sbp,thol,hdl) => {
// SCORE2 calculation (for Moderate Risk Regions)
const score2Risk = score2("Moderate", sex, age, smoking, sbp, thol, hdl);
return {score2Risk};
}});

define({id: "d3b218c2", inputs: ["age","score2Risk","Plot","labels"], outputs: ["thresholds","riskLevel","riskColors","thresholds_labels","riskLegend"], body: (age,score2Risk,Plot,labels) => {
// Risk level calculation and legend
// Define risk thresholds [high, veryHigh] based on age groups
const thresholds = age < 50 ? [0.025, 0.075] : [0.05, 0.1];
// Assign risk level index (0: lowModerate, 1: high, 2: veryHigh)
const riskLevel =
  score2Risk >= thresholds[1] ? 2 : score2Risk >= thresholds[0] ? 1 : 0;

// Define risk colors
const riskColors = ["#55bd92", "#f79228", "#ad1e28"];
// Define risk thresholds range labels
const thresholds_labels = [
  `(<${thresholds[0] * 100}%)`,
  `(${thresholds[0] * 100}-${thresholds[1] * 100}%)`,
  `(â‰¥${thresholds[1] * 100}%)`,
];

const riskLegend = Plot.plot({
  color: {
    legend: true,
    type: "categorical",
    tickFormat: (i) =>
      `${labels?.riskLevels?.[i] || ""} ${thresholds_labels[i]}`,
    domain: [0, 1, 2],
    columns: 1,
    className: "legend",
    swatchSize: 16,
    range: ["#55bd92", "#f79228", "#ad1e28"],
  },
});
return {thresholds,riskLevel,riskColors,thresholds_labels,riskLegend};
}});

define({id: "44ff0167", inputs: ["data","score2Risk"], outputs: ["score2_surrogate_risk","surrogate_abs_error"], body: (data,score2Risk) => {
// Check Surrogate Model Error
const score2_surrogate_risk = data.reduce((total, variable) => {
  return (
    total +
    (variable.coefficient * (variable.value - variable.min)) /
      (variable.max - variable.min)
  );
}, 0);

const surrogate_abs_error = Math.abs(score2_surrogate_risk - score2Risk);
return {score2_surrogate_risk,surrogate_abs_error};
}});

define({id: "63fc0dc4", inputs: ["thol","hdl","sex","fullData","age","sbp","smoking"], outputs: ["nonhdl","numLobes","data"], body: (thol,hdl,sex,fullData,age,sbp,smoking) => {
const nonhdl = thol - hdl;
const numLobes = 10 + sex; // male=10, female=11
let data = fullData
  .filter((d) => d.sex === sex)
  .map((d) => ({
    ...d,
    value:
      d.id === "age"
        ? age
        : d.id === "sbp"
        ? sbp
        : d.id === "smoking"
        ? smoking
        : nonhdl,
  }));
return {nonhdl,numLobes,data};
}});

define({id: "10af193d", inputs: ["nonhdl","data","surrogate_abs_error","petalx","labels","numLobes","riskColors","riskLevel"], outputs: ["plot"], body: (nonhdl,data,surrogate_abs_error,petalx,labels,numLobes,riskColors,riskLevel) => {
// Change values to min if nonhdl is out of range so no petals are drawn
if (nonhdl < 3 || nonhdl > 7) data.forEach((d) => (d.value = d.min));
// Change values to min if error > 2% is out of range so no petals are drawn
if (surrogate_abs_error > 0.02) data.forEach((d) => (d.value = d.min));

const plot = (width, height) =>
  petalx(data, labels, {
    width,
    height,
    radialMargin: 0.55,
    lobes: numLobes,
    joinRatio: 0.5,
    levels: () => labels.binaryLevels,
    color: () => riskColors[riskLevel],
  });
return {plot};
}});

define({id: "aeb4f57b", mode: "inline", inputs: ["labels","display"], body: async (labels,display) => {
display(await(
labels.title
))
}});

define({id: "37c41e44", mode: "inline", inputs: ["labels","display"], body: async (labels,display) => {
display(await(
labels.subtitle
))
}});

define({id: "d70372af", mode: "inline", inputs: ["riskLegend","display"], body: async (riskLegend,display) => {
display(await(
riskLegend
))
}});

define({id: "5dced734", mode: "inline", inputs: ["resize","plot","display"], body: async (resize,plot,display) => {
display(await(
resize(plot)
))
}});

define({id: "f440ec00", mode: "inline", inputs: ["nonhdl","html","labels","display"], body: async (nonhdl,html,labels,display) => {
display(await(
(nonhdl < 3 || nonhdl > 7) ? html`<div class="caution absolute-center"  label="${labels.nonhdlWarning.title}">${labels.nonhdlWarning.message}</div>` : ""
))
}});

define({id: "016f8c60", mode: "inline", inputs: ["surrogate_abs_error","html","labels","display"], body: async (surrogate_abs_error,html,labels,display) => {
display(await(
(surrogate_abs_error > 0.02) ? html`<div class="warning absolute-center"  label="${labels.riskExplanationWarning.title}">${labels.riskExplanationWarning.message}</div>` : ""
))
}});

define({id: "11502a1e", mode: "inline", inputs: ["labels","display"], body: async (labels,display) => {
display(await(
labels.risk
))
}});

define({id: "d8416459", mode: "inline", inputs: ["nonhdl","html","riskColors","riskLevel","score2Risk","display"], body: async (nonhdl,html,riskColors,riskLevel,score2Risk,display) => {
display(await(
(nonhdl < 3 || nonhdl > 7) ? html`<span class="big" style="color: ${riskColors[2]}">â€”</span>` :
      html`<span class="big" style="color: ${riskColors[riskLevel]}">${(score2Risk * 100).toFixed(1)}%</span>`
))
}});

define({id: "560ab59c", mode: "inline", inputs: ["labels","display"], body: async (labels,display) => {
display(await(
labels.inputs.patient
))
}});

define({id: "f5d993d6", mode: "inline", inputs: ["patientInput","display"], body: async (patientInput,display) => {
display(await(
patientInput
))
}});

define({id: "2aabb218", mode: "inline", inputs: ["labels","display"], body: async (labels,display) => {
display(await(
labels.inputs.sex
))
}});

define({id: "eae24a5c", mode: "inline", inputs: ["labels","sex","display"], body: async (labels,sex,display) => {
display(await(
labels.sexLevels[sex]
))
}});

define({id: "11cf77d0", mode: "inline", inputs: ["sexInput","display"], body: async (sexInput,display) => {
display(await(
sexInput
))
}});

define({id: "80c6ba82", mode: "inline", inputs: ["labels","display"], body: async (labels,display) => {
display(await(
labels.inputs.age
))
}});

define({id: "013f5440", mode: "inline", inputs: ["age","display"], body: async (age,display) => {
display(await(
age
))
}});

define({id: "199cb881", mode: "inline", inputs: ["ageInput","display"], body: async (ageInput,display) => {
display(await(
ageInput
))
}});

define({id: "c395b236", mode: "inline", inputs: ["labels","display"], body: async (labels,display) => {
display(await(
labels.inputs.sbp
))
}});

define({id: "fa79034a", mode: "inline", inputs: ["sbp","display"], body: async (sbp,display) => {
display(await(
sbp
))
}});

define({id: "706343a3", mode: "inline", inputs: ["sbpInput","display"], body: async (sbpInput,display) => {
display(await(
sbpInput
))
}});

define({id: "e15a019d", mode: "inline", inputs: ["labels","display"], body: async (labels,display) => {
display(await(
labels.inputs.smoking
))
}});

define({id: "5e2d4f1c", mode: "inline", inputs: ["labels","smoking","display"], body: async (labels,smoking,display) => {
display(await(
labels.binaryLevels[smoking]
))
}});

define({id: "a99ec284", mode: "inline", inputs: ["smokingInput","display"], body: async (smokingInput,display) => {
display(await(
smokingInput
))
}});

define({id: "5ac99f8f", mode: "inline", inputs: ["labels","display"], body: async (labels,display) => {
display(await(
labels.inputs.thol
))
}});

define({id: "f434f085", mode: "inline", inputs: ["thol","display"], body: async (thol,display) => {
display(await(
thol
))
}});

define({id: "e106c499", mode: "inline", inputs: ["tholInput","display"], body: async (tholInput,display) => {
display(await(
tholInput
))
}});

define({id: "595ecba3", mode: "inline", inputs: ["labels","display"], body: async (labels,display) => {
display(await(
labels.inputs.hdl
))
}});

define({id: "a1a40ac5", mode: "inline", inputs: ["hdl","display"], body: async (hdl,display) => {
display(await(
hdl
))
}});

define({id: "b45dc804", mode: "inline", inputs: ["hdlInput","display"], body: async (hdlInput,display) => {
display(await(
hdlInput
))
}});

</script>
</head>
<body>
<div id="observablehq-center">
<header id="observablehq-header">
<div id="header-container" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
  <div style="flex-grow: 1; flex-shrink: 1; flex-basis: 0; display: flex; align-items: center; gap: 10px;">
    <img src="./_file/petalx.d4784297.svg" height="24">
    Petal-X: Cardiovascular Disease (CVD) Risk Calculator
  </div>
  <div style="display: flex; align-items: center; gap: 20px; margin-top: -8px;">
    <img src="./_file/fzv_logo.dd9ca213.png" height="48" alt="University of Maribor - Faculty of Health Sciences logo">
    <img src="./_file/kuleuven_logo.3df22547.png" height="48" alt="KU Leuven logo">
    <img src="./_file/zdl_logo.1f04bbcd.png" height="48" alt="Community Health Centre Ljubljana logo" style="margin-right: 0.75rem;">
  </div>
</div>
</header>
<aside id="observablehq-toc" data-selector="h1:not(:first-of-type)[id], h2:first-child[id], :not(h1) + h2[id]">
<nav>
</nav>
</aside>
<main id="observablehq-main" class="observablehq">
<div class="observablehq observablehq--block"><!--:ea9db2f2:--></div>
<div class="observablehq observablehq--block"><!--:34b79cae:--></div>
<div class="observablehq observablehq--block"><!--:2a2bbd08:--></div>
<div class="observablehq observablehq--block"><!--:1257a42e:--></div>
<div class="observablehq observablehq--block"><!--:d3b218c2:--></div>
<div class="observablehq observablehq--block"><!--:44ff0167:--></div>
<div class="observablehq observablehq--block"><!--:63fc0dc4:--></div>
<div class="observablehq observablehq--block"><!--:10af193d:--></div>
<div class="grid grid-cols-3">
  <div class="card grid-colspan-2 plot-panel">
    <h2><observablehq-loading></observablehq-loading><!--:aeb4f57b:--></h2>
    <h3><observablehq-loading></observablehq-loading><!--:37c41e44:--></h3>
    <div class="plot-container"><observablehq-loading></observablehq-loading><!--:d70372af:--><observablehq-loading></observablehq-loading><!--:5dced734:--></div>
    <observablehq-loading></observablehq-loading><!--:f440ec00:-->
    <observablehq-loading></observablehq-loading><!--:016f8c60:-->
  </div>
  <div class="input-panel">
    <div class="card">
      <h2><observablehq-loading></observablehq-loading><!--:11502a1e:--></h2>
      <observablehq-loading></observablehq-loading><!--:d8416459:-->
    </div>
    <div class="card grid grid-cols-2">
      <div>
        <h3><observablehq-loading></observablehq-loading><!--:560ab59c:--></h3>
        <div><observablehq-loading></observablehq-loading><!--:f5d993d6:--></div>
      </div>
      <div>
        <h3><observablehq-loading></observablehq-loading><!--:2aabb218:--></h3>
        <span class="medium"><observablehq-loading></observablehq-loading><!--:eae24a5c:--></span>
        <div><observablehq-loading></observablehq-loading><!--:11cf77d0:--></div>
      </div>
    </div>
    <div class="card">
      <h3><observablehq-loading></observablehq-loading><!--:80c6ba82:--></h3>
      <span class="medium"><observablehq-loading></observablehq-loading><!--:013f5440:--> let</span>
      <div><observablehq-loading></observablehq-loading><!--:199cb881:--></div>
    </div>
    <div class="card">
      <h3><observablehq-loading></observablehq-loading><!--:c395b236:--></h3>
      <span class="medium"><observablehq-loading></observablehq-loading><!--:fa79034a:--> mmHg</span>
      <div><observablehq-loading></observablehq-loading><!--:706343a3:--></div>
    </div>
    <div class="card">
      <h3><observablehq-loading></observablehq-loading><!--:e15a019d:--></h3>
      <span class="medium"><observablehq-loading></observablehq-loading><!--:5e2d4f1c:--></span>
      <div><observablehq-loading></observablehq-loading><!--:a99ec284:--></div>
    </div>
    <div class="card">
      <h3><observablehq-loading></observablehq-loading><!--:5ac99f8f:--></h3>
      <span class="medium"><observablehq-loading></observablehq-loading><!--:f434f085:--> mmol/L</span>
      <div><observablehq-loading></observablehq-loading><!--:e106c499:--></div>
    </div>
    <div class="card">
      <h3><observablehq-loading></observablehq-loading><!--:595ecba3:--></h3>
      <span class="medium"><observablehq-loading></observablehq-loading><!--:a1a40ac5:--> mmol/L</span>
      <div><observablehq-loading></observablehq-loading><!--:b45dc804:--></div>
    </div>
  </div>
</div>
<style>
  .medium {
    font-weight: 600;
    font-size: 18px;
    line-height: 1;
  }

  .plot-d6a7b5-figure {
    position: absolute;
    height: 62px;
    width: 265px;
    right: 10px;
    top: 10px;
    background-color: white;
    padding: 5px 15px;
    border-radius: 0.75rem;
    border: 1px solid #dfdfdf;
  }

  .legend-swatches {
    font-size: 14px;
  }

  input[type="text"] {
    font-weight: 600;
  }

  .plot-container {
    height: 95%;
  }

  .input-panel .card:first-child {
    margin-top: 0;
  }

  .input-panel .card:last-child {
    margin-bottom: 0;
  }

  .plot-panel {
    position: relative;
  }

  .absolute-center {
    position: absolute;
    top: 20%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    width: 100%;
  }

  .note.absolute-center {
    z-index: 10;
  }

  .warning.absolute-center {
    z-index: 9;
  }
  #observablehq-footer {
    margin-top: 0px;
    padding-top: 0px;
    margin-left: 0.75rem;
  }

  #observablehq-main {
    margin-top: 4rem !important;
    margin-bottom: 0rem !important;
  }

  #header-container {
    padding-right: 0; /* Default padding for smaller screens */
  }

  #header-container > div:first-child {
    display: flex;
    align-items: center;
    gap: 10px; /* Adjust gap if needed */
  }

  @media (min-width: calc(832px + 5rem)) {
    #header-container {
      padding-right: calc(192px + 1rem);
    }
  }
</style>
</main>
<footer id="observablehq-footer">
<div>Built with ðŸ«€ by <a href="mailto:rojo@hey.com" target="_blank" rel="noopener noreferrer">Diego Rojo</a> <a href="https://github.com/93degree" style="text-decoration: none;" target="_blank" rel="noopener noreferrer"><img src="./_file/github.7a0dd11e.svg" height="12" style="vertical-align: text-top; margin-left: 4px;"></a></div>
</footer>
</div>
</body>
</html>
